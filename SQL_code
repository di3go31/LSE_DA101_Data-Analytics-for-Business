-- which products are the most popular in each country 

WITH product_spend AS (
    SELECT "Country", 'Liquor' AS product, SUM("AmtLiq") AS total_spend
    FROM marketing_data
    GROUP BY "Country"

    UNION ALL
    SELECT "Country", 'Vegetables', SUM("AmtVege")
    FROM marketing_data
    GROUP BY "Country"

    UNION ALL
    SELECT "Country", 'NonVegetables', SUM("AmtNonVeg")
    FROM marketing_data
    GROUP BY "Country"

    UNION ALL
    SELECT "Country", 'Fish', SUM("AmtPes")
    FROM marketing_data
    GROUP BY "Country"

    UNION ALL
    SELECT "Country", 'Chocolates', SUM("AmtChocolates")
    FROM marketing_data
    GROUP BY "Country"

    UNION ALL
    SELECT "Country", 'Commodities', SUM("AmtComm")
    FROM marketing_data
    GROUP BY "Country"
),
ranked_products AS (
    SELECT
        "Country",
        product,
        total_spend,
        ROW_NUMBER() OVER (
            PARTITION BY "Country"
            ORDER BY total_spend DESC
        ) AS rn
    FROM product_spend
)
SELECT
    "Country",
    product AS most_popular_product,
    total_spend
FROM ranked_products
WHERE rn = 1
ORDER BY "Country";

Which products are most popular based on marital status 
- highest total revenue per product, grouped by marital status
  - first the total revenue per product 
-- highest total revenue per product, grouped by marital status
SELECT
    marketing_data."Marital_Status",
    SUM("AmtLiq") AS total_revenue_liquor,
    SUM("AmtVege") AS total_revenue_vege,
    SUM("AmtNonVeg") AS total_revenue_non_veg,
    SUM("AmtPes") AS total_revenue_fish,
    SUM("AmtChocolates") AS total_revenue_chocolated,
    SUM("AmtComm") AS total_revenue_comm
FROM
    marketing_data
GROUP BY
"Marital_Status";

- and now the highest revenue product grouped by marital status 
-- Step 1: Use query as a base to calculate total revenue for all products
WITH RevenueByStatus AS (
    SELECT
        "Marital_Status",
        SUM("AmtLiq") AS "Liquor",
        SUM("AmtVege") AS "Vegetables",
        SUM("AmtNonVeg") AS "Non-Veg",
        SUM("AmtPes") AS "Fish",
        SUM("AmtChocolates") AS "Chocolates",
        SUM("AmtComm") AS "Commodities"
    FROM
        marketing_data
    GROUP BY
        "Marital_Status"
),

-- Step 2: Unpivot the data to compare products within each group
UnpivotedRevenue AS (
    SELECT "Marital_Status", 'Liquor' AS product_category, "Liquor" AS revenue FROM RevenueByStatus
    UNION ALL
    SELECT "Marital_Status", 'Vegetables' AS product_category, "Vegetables" AS revenue FROM RevenueByStatus
    UNION ALL
    SELECT "Marital_Status", 'Non-Veg' AS product_category, "Non-Veg" AS revenue FROM RevenueByStatus
    UNION ALL
    SELECT "Marital_Status", 'Fish' AS product_category, "Fish" AS revenue FROM RevenueByStatus
    UNION ALL
    SELECT "Marital_Status", 'Chocolates' AS product_category, "Chocolates" AS revenue FROM RevenueByStatus
    UNION ALL
    SELECT "Marital_Status", 'Commodities' AS product_category, "Commodities" AS revenue FROM RevenueByStatus
),

-- Step 3: Rank the products for each marital status by revenue
RankedRevenue AS (
    SELECT
        "Marital_Status",
        product_category,
        revenue,
        ROW_NUMBER() OVER(PARTITION BY "Marital_Status" ORDER BY revenue DESC) as rank_num
    FROM
        UnpivotedRevenue
)

-- Step 4: Select only the top-ranked product for each status
SELECT
    "Marital_Status",
    product_category AS top_product_by_revenue,
    revenue AS highest_revenue
FROM
    RankedRevenue
WHERE
    rank_num = 1;

- highest number of customers who made a purchase on a product (product with the most buyers), grouped by marital status
   - first, the total number of customers who made a purchase for each product grouped by marital status 
 

- each product and which one has the most buyers 
-- Step 1: Use your query as a base to calculate buyer counts for all products
WITH BuyerCounts AS (
    SELECT
        "Marital_Status",
        COUNT(*) FILTER (WHERE "AmtLiq" > 0)        AS "Liquor",
        COUNT(*) FILTER (WHERE "AmtVege" > 0)       AS "Vegetables",
        COUNT(*) FILTER (WHERE "AmtNonVeg" > 0)     AS "Non-Veg",
        COUNT(*) FILTER (WHERE "AmtPes" > 0)        AS "Fish",
        COUNT(*) FILTER (WHERE "AmtChocolates" > 0) AS "Chocolates",
        COUNT(*) FILTER (WHERE "AmtComm" > 0)       AS "Commodities"
    FROM
        marketing_data
    GROUP BY
        "Marital_Status"
),

-- Step 2: Unpivot the data to compare products within each group
UnpivotedCounts AS (
    SELECT "Marital_Status", 'Liquor' AS product_category, "Liquor" AS buyer_count FROM BuyerCounts
    UNION ALL
    SELECT "Marital_Status", 'Vegetables' AS product_category, "Vegetables" AS buyer_count FROM BuyerCounts
    UNION ALL
    SELECT "Marital_Status", 'Non-Veg' AS product_category, "Non-Veg" AS buyer_count FROM BuyerCounts
    UNION ALL
    SELECT "Marital_Status", 'Fish' AS product_category, "Fish" AS buyer_count FROM BuyerCounts
    UNION ALL
    SELECT "Marital_Status", 'Chocolates' AS product_category, "Chocolates" AS buyer_count FROM BuyerCounts
    UNION ALL
    SELECT "Marital_Status", 'Commodities' AS product_category, "Commodities" AS buyer_count FROM BuyerCounts
),

-- Step 3: Rank the products for each marital status by buyer count
RankedCounts AS (
    SELECT
        "Marital_Status",
        product_category,
        buyer_count,
        ROW_NUMBER() OVER(PARTITION BY "Marital_Status" ORDER BY buyer_count DESC) as rank_num
    FROM
        UnpivotedCounts
)

-- Step 4: Select only the top-ranked product for each status
SELECT
    "Marital_Status",
    product_category AS top_product_by_buyers,
    buyer_count AS highest_buyer_count
FROM
    RankedCounts
WHERE
rank_num = 1;
 

- highest average of total revenue for a product, grouped by marital status
- first, the average total revenue per product grouped by marital status
 
- now the highest average spend per product grouped by marital status
WITH average_spends AS (
    SELECT
        "Marital_Status",
        AVG(NULLIF("AmtLiq", 0))         AS liquor,
        AVG(NULLIF("AmtVege", 0))        AS vegetables,
        AVG(NULLIF("AmtNonVeg", 0))      AS non_veg,
        AVG(NULLIF("AmtPes", 0))         AS fish,
        AVG(NULLIF("AmtChocolates", 0))  AS chocolates,
        AVG(NULLIF("AmtComm", 0))        AS commodities
    FROM marketing_data
    GROUP BY "Marital_Status"
),
unpivoted AS (
    SELECT "Marital_Status", 'Liquor'      AS product_category, liquor      AS avg_spend FROM average_spends
    UNION ALL
    SELECT "Marital_Status", 'Vegetables', vegetables                      FROM average_spends
    UNION ALL
    SELECT "Marital_Status", 'Non-Veg',    non_veg                          FROM average_spends
    UNION ALL
    SELECT "Marital_Status", 'Fish',       fish                             FROM average_spends
    UNION ALL
    SELECT "Marital_Status", 'Chocolates', chocolates                       FROM average_spends
    UNION ALL
    SELECT "Marital_Status", 'Commodities', commodities                     FROM average_spends
),
ranked AS (
    SELECT
        "Marital_Status",
        product_category,
        avg_spend,
        ROW_NUMBER() OVER (
            PARTITION BY "Marital_Status"
            ORDER BY avg_spend DESC NULLS LAST
        ) AS rn
    FROM unpivoted
)
SELECT
    "Marital_Status",
    product_category AS top_product_by_avg_spend,
    ROUND(avg_spend::numeric, 2) AS highest_avg_spend
FROM ranked
WHERE rn = 1
ORDER BY "Marital_Status";
 

Which products are the most popular based on whether or not there are children or teens in the home?
WITH household_groups AS (
    SELECT
        CASE
            WHEN "Kidhome" = 0 AND "Teenhome" = 0
                THEN 'No children or teens'
            ELSE 'Children or teens present'
        END AS household_type,
        "AmtLiq", "AmtVege", "AmtNonVeg", "AmtPes", "AmtChocolates", "AmtComm"
    FROM marketing_data
),
averages AS (
    SELECT
        household_type,
        AVG(NULLIF("AmtLiq", 0))        AS liquor,
        AVG(NULLIF("AmtVege", 0))       AS vegetables,
        AVG(NULLIF("AmtNonVeg", 0))     AS non_veg,
        AVG(NULLIF("AmtPes", 0))        AS fish,
        AVG(NULLIF("AmtChocolates", 0)) AS chocolates,
        AVG(NULLIF("AmtComm", 0))       AS commodities
    FROM household_groups
    GROUP BY household_type
),
unpivoted AS (
    SELECT household_type, 'Liquor' AS product, liquor AS avg_spend FROM averages
    UNION ALL SELECT household_type, 'Vegetables', vegetables FROM averages
    UNION ALL SELECT household_type, 'Non-Veg', non_veg FROM averages
    UNION ALL SELECT household_type, 'Fish', fish FROM averages
    UNION ALL SELECT household_type, 'Chocolates', chocolates FROM averages
    UNION ALL SELECT household_type, 'Commodities', commodities FROM averages
),
ranked AS (
    SELECT
        household_type,
        product,
        avg_spend,
        ROW_NUMBER() OVER (
            PARTITION BY household_type
            ORDER BY avg_spend DESC NULLS LAST
        ) AS rn
    FROM unpivoted
)
SELECT
    household_type,
    product AS most_popular_product,
    ROUND(avg_spend, 2) AS avg_spend
FROM ranked
WHERE rn = 1;
 




